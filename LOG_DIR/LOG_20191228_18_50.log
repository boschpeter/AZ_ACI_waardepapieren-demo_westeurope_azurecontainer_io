20191228_18_50 - BEGIN JOB:
-----------------------------------------------------------------------------
| 20191228_18_50 | docker-compose-travis.yml|
| 20191228_18_50 | /Users/boscp08/Projects/scratch/virtual-insanity/AZ_ACI_waardepapieren-demo_westeurope_azurecontainer_io |
<code>
version: '3'
services:
  waardepapieren-service:
    volumes:
      #- ./waardepapieren-service/system-test/certs:/certs:rw
      #- ./waardepapieren-service/system-test/ephemeral-certs:/ephemeral-certs:rw
      - ./waardepapieren-service/configuration/:/app/configuration2:rw  #FAKE
    build: waardepapieren-service/.
    links:
      - mock-nlx
    ports:
      - 3232:3232
      - 3233:3233
    environment:
      - WAARDEPAPIEREN_CONFIG=/app/configuration/waardepapieren-config-compose-travis.json
      # Ignore self-signed ephemeral cert issues
      - NODE_TLS_REJECT_UNAUTHORIZED=0
  clerk-frontend:
    build:
      context: clerk-frontend/
      args:
        - CERTIFICATE_HOST=http://waardepapieren-demo.westeurope.azurecontainer.io:8880
    links:
      - waardepapieren-service
    ports:
      - 443:443
      - 8880:8880
    healthcheck:
      test: service nginx status
  #  volumes:
  #    - ./clerk-frontend/nginx/certs:/etc/nginx/certs:rw
  mock-nlx:
    build: mock-nlx/
    ports:
      - 80:80
</code>
20191228_18_50 - END JOB :
-----------------------------------------------------------------------------
20191228_18_50 - BEGIN JOB:
-----------------------------------------------------------------------------
| 20191228_18_50 | Dockerfile|
| 20191228_18_50 | /Users/boscp08/Projects/scratch/virtual-insanity/AZ_ACI_waardepapieren-demo_westeurope_azurecontainer_io/clerk-frontend |
<code>
FROM node:10
RUN mkdir /app
ADD package.json package-lock.json /app/
ENV REACT_APP_EPHEMERAL_ENDPOINT=https://waardepapieren-demo.westeurope.azurecontainer.io:443/api/eph
ENV REACT_APP_EPHEMERAL_WEBSOCKET_ENDPOINT=wss://waardepapieren-demo.westeurope.azurecontainer.io:443/api/eph-ws
WORKDIR /app
RUN npm install --unsafe-perm
ADD public /app/public
ADD src /app/src
ARG CERTIFICATE_HOST
ENV REACT_APP_CERTIFICATE_HOST=http://waardepapieren-demo.westeurope.azurecontainer.io:8880
ENV TZ=Europe/Amsterdam
RUN npm run build

FROM nginx:1.15.8
ADD nginx/nginx.conf /etc/nginx/nginx.conf
COPY --from=0 /app/build /usr/share/nginx/html
#  volumes:
#    - ./clerk-frontend/nginx/certs:/etc/nginx/certs:rw
RUN mkdir /etc/nginx/certs
RUN apt-get update 
RUN apt-get install -y iputils-ping
RUN apt-get install -y net-tools

ADD nginx/certs/org.crt /etc/nginx/certs/org.crt
ADD nginx/certs/org.key /etc/nginx/certs/org.key
</code>
20191228_18_50 - END JOB :
-----------------------------------------------------------------------------
20191228_18_50 - BEGIN JOB:
-----------------------------------------------------------------------------
| 20191228_18_50 | Dockerfile|
| 20191228_18_50 | /Users/boscp08/Projects/scratch/virtual-insanity/AZ_ACI_waardepapieren-demo_westeurope_azurecontainer_io/waardepapieren-service |
<code>
FROM node:10
RUN mkdir /app
ADD .babelrc package.json package-lock.json /app/
ADD src/* app/src/
ADD configuration/* app/configuration/
#- ./waardepapieren-service/system-test/certs:/certs:ro
RUN mkdir /certs
ADD system-test/certs/org.crt /certs/org.crt
ADD system-test/certs/org.key /certs/org.key
#- ./waardepapieren-service/system-test/ephemeral-certs:/ephemeral-certs:ro
RUN mkdir /ephemeral-certs
ADD system-test/ephemeral-certs/org.crt /ephemeral-certs/
ADD system-test/ephemeral-certs/org.key /ephemeral-certs/
#- ./waardepapieren-service/configuration/:/app/configuration:ro

WORKDIR /app
RUN mkdir /configuration
ADD configuration/waardepapieren-config-compose.json /app/configuration
ADD configuration/waardepapieren-config-compose-travis.json /app/configuration
ADD configuration/waardepapieren-config.json /app/configuration
ENV WAARDEPAPIEREN_CONFIG /app/configuration/waardepapieren-config.json
ENV TZ=Europe/Amsterdam
RUN apt-get update 
RUN apt-get install -y iputils-ping
RUN apt-get install -y net-tools

RUN npm install --production
CMD npm start
</code>
20191228_18_50 - END JOB :
-----------------------------------------------------------------------------
20191228_18_50 - BEGIN JOB:
-----------------------------------------------------------------------------
| 20191228_18_50 | Dockerfile|
| 20191228_18_50 | /Users/boscp08/Projects/scratch/virtual-insanity/AZ_ACI_waardepapieren-demo_westeurope_azurecontainer_io/mock-nlx |
<code>
FROM node:10
RUN mkdir /app
ADD index.js package.json package-lock.json /app/
WORKDIR /app
ENV TZ=Europe/Amsterdam
RUN npm install --production
</code>
20191228_18_50 - END JOB :
-----------------------------------------------------------------------------
20191228_18_50 - BEGIN JOB:
-----------------------------------------------------------------------------
| 20191228_18_50 | waardepapieren-config-compose-travis.json|
| 20191228_18_50 | =/Users/boscp08/Projects/scratch/virtual-insanity/AZ_ACI_waardepapieren-demo_westeurope_azurecontainer_io/waardepapieren-service/configuration |
<code>
 {
   "EPHEMERAL_ENDPOINT" : "https://waardepapieren-demo.westeurope.azurecontainer.io:3232",
   "EPHEMERAL_WEBSOCKET_ENDPOINT" : "wss://waardepapieren-demo.westeurope.azurecontainer.io:3232",
   "EPHEMERAL_CERT": "/ephemeral-certs/org.crt",
   "EPHEMERAL_KEY": "/ephemeral-certs/org.key",
  "NLX_OUTWAY_ENDPOINT" : "http://waardepapieren-demo.westeurope.azurecontainer.io:80",
  "NLX_CERT": "/certs/org.crt",
  "NLX_KEY": "/certs/org.key",
  "LOG_LEVEL": "info",
  "EPHEMERAL_RETENTION_TIME": 2591205,
  "PRODUCT_NEED" : "BRP_UITTREKSEL_NEED",
  "SOURCE_NLX_PATH" : "/brp/basisregistratie/natuurlijke_personen/bsn/{BSN}",
  "SOURCE_ARGUMENT" : "BSN",
  "PRODUCT_ACCEPT" : "BRP_UITTREKSEL_ACCEPT",
  "PRODUCT_NAME" : "Gewaarmerkt digitaal afschrift van gegevens uit de basisregistratie personen (BRP)",
  "PRODUCT_DESCRIPTION" : "Uittreksel Basis Registratie Persoonsgegevens",
  "PRODUCT_PURPOSE" : "Bewijs verblijfadres in woonplaats",
  "SOURCE_DATA_SELECTION" : [
    {"Burgerservicenummer (BSN)" : "burgerservicenummer"},
    {"Woonplaats verblijfadres" : "verblijfadres.woonplaats"}
  ]
} 
</code>
20191228_18_50 - END JOB :
-----------------------------------------------------------------------------
20191228_18_50 - BEGIN JOB:
-----------------------------------------------------------------------------
| 20191228_18_50 | waardepapieren-config-compose.json|
| 20191228_18_50 | /Users/boscp08/Projects/scratch/virtual-insanity/AZ_ACI_waardepapieren-demo_westeurope_azurecontainer_io/waardepapieren-service/configuration |
<code>
 {
   "EPHEMERAL_ENDPOINT" : "https://waardepapieren-demo.westeurope.azurecontainer.io:3232",
   "EPHEMERAL_WEBSOCKET_ENDPOINT" : "wss://waardepapieren-demo.westeurope.azurecontainer.io:3232",
   "EPHEMERAL_CERT": "/ephemeral-certs/org.crt",
   "EPHEMERAL_KEY": "/ephemeral-certs/org.key",
  "NLX_OUTWAY_ENDPOINT" : "http://waardepapieren-demo.westeurope.azurecontainer.io:80",
  "NLX_CERT": "/certs/org.crt",
  "NLX_KEY": "/certs/org.key",
  "LOG_LEVEL": "info",
  "EPHEMERAL_RETENTION_TIME": 2591205,
  "PRODUCT_NEED" : "BRP_UITTREKSEL_NEED",
  "SOURCE_NLX_PATH" : "/brp/basisregistratie/natuurlijke_personen/bsn/{BSN}",
  "SOURCE_ARGUMENT" : "BSN",
  "PRODUCT_ACCEPT" : "BRP_UITTREKSEL_ACCEPT",
  "PRODUCT_NAME" : "Gewaarmerkt digitaal afschrift van gegevens uit de basisregistratie personen (BRP)",
  "PRODUCT_DESCRIPTION" : "Uittreksel Basis Registratie Persoonsgegevens",
  "PRODUCT_PURPOSE" : "Bewijs verblijfadres in woonplaats",
  "SOURCE_DATA_SELECTION" : [
    {"Burgerservicenummer (BSN)" : "burgerservicenummer"},
    {"Woonplaats verblijfadres" : "verblijfadres.woonplaats"}
  ]
} 
</code>
20191228_18_50 - END JOB :
-----------------------------------------------------------------------------
20191228_18_50 - BEGIN JOB:
-----------------------------------------------------------------------------
| 20191228_18_50 | waardepapieren-config.json|
| 20191228_18_50 | /Users/boscp08/Projects/scratch/virtual-insanity/AZ_ACI_waardepapieren-demo_westeurope_azurecontainer_io/waardepapieren-service/configuration |
<code>
 {
   "EPHEMERAL_ENDPOINT" : "https://waardepapieren-demo.westeurope.azurecontainer.io:3232",
   "EPHEMERAL_WEBSOCKET_ENDPOINT" : "wss://waardepapieren-demo.westeurope.azurecontainer.io:3232",
   "EPHEMERAL_CERT": "/ephemeral-certs/org.crt",
   "EPHEMERAL_KEY": "/ephemeral-certs/org.key",
  "NLX_OUTWAY_ENDPOINT" : "http://waardepapieren-demo.westeurope.azurecontainer.io:80",
  "NLX_CERT": "/certs/org.crt",
  "NLX_KEY": "/certs/org.key",
  "LOG_LEVEL": "info",
  "EPHEMERAL_RETENTION_TIME": 2591205,
  "PRODUCT_NEED" : "BRP_UITTREKSEL_NEED",
  "SOURCE_NLX_PATH" : "/brp/basisregistratie/natuurlijke_personen/bsn/{BSN}",
  "SOURCE_ARGUMENT" : "BSN",
  "PRODUCT_ACCEPT" : "BRP_UITTREKSEL_ACCEPT",
  "PRODUCT_NAME" : "Gewaarmerkt digitaal afschrift van gegevens uit de basisregistratie personen (BRP)",
  "PRODUCT_DESCRIPTION" : "Uittreksel Basis Registratie Persoonsgegevens",
  "PRODUCT_PURPOSE" : "Bewijs verblijfadres in woonplaats",
  "SOURCE_DATA_SELECTION" : [
    {"Burgerservicenummer (BSN)" : "burgerservicenummer"},
    {"Woonplaats verblijfadres" : "verblijfadres.woonplaats"}
  ]
} 
</code>
20191228_18_50 - END JOB :
-----------------------------------------------------------------------------
20191228_18_50 - BEGIN JOB:
-----------------------------------------------------------------------------
| 20191228_18_50 | nginx.conf|
| 20191228_18_50 | /Users/boscp08/Projects/scratch/virtual-insanity/AZ_ACI_waardepapieren-demo_westeurope_azurecontainer_io/clerk-frontend |
<code>
events {
    worker_connections  1024;
}

http {

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # Http server to obtain NLX certificate
    server {
        listen 8880;

        location / {
           root /usr/share/nginx/html;
           include /etc/nginx/mime.types;
        }
    }

    server {
        listen 443 ssl;

        ssl_certificate /etc/nginx/certs/org.crt;
        ssl_certificate_key /etc/nginx/certs/org.key;

        location /api/eph/ {
               proxy_pass https://waardepapieren-demo.westeurope.azurecontainer.io:3232/;    #pdf effect
           #     proxy_pass https://waardepapieren-service:3232/;
            #     proxy_pass https://172.19.0.3:3232/;
        }

        location /api/eph-ws {
           
              proxy_pass https://waardepapieren-demo.westeurope.azurecontainer.io:3232;   # pdf effect
             #  proxy_pass https://waardepapieren-service:3232;
            #  proxy_pass https://172.19.0.3:3232;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection Upgrade;
        }
        location / {
            root /usr/share/nginx/html;
            include /etc/nginx/mime.types;
        }
    }
}
</code>
20191228_18_50 - END JOB :
-----------------------------------------------------------------------------
20191228_18_50 - BEGIN JOB:
-----------------------------------------------------------------------------
| 20191228_18_50 | deploy-aci.yaml|
| 20191228_18_50 | /Users/boscp08/Projects/scratch/virtual-insanity |
<code>
location: westeurope
name: Waardepapieren_demo_ACI_1
properties:
  containers:
  - name: waardepapieren_mock_nlx
    properties:
      image: boscp08/waardepapieren_mock_nlx:1.0
      resources:
        requests:
          cpu: 1
          memoryInGb: 0.5
      ports:
      - port: 80
  - name: waardepapieren_service:
    properties:
      image: boscp08/waardepapieren_service:1.0
      resources:
        requests:
          cpu: 1
          memoryInGb: 0.5
      ports:
      - port: 3232
  - name: waardepapieren_clerk_frontend
    properties:
      image: boscp08/waardepapieren_clerk_frontend:1.0
      resources:
        requests:
          cpu: 1
          memoryInGb: 0.5
      ports:
      - port: 443
      - port: 8880
  osType: Linux
  ipAddress:
    type: Public
    # fqdn wordt: discipl_waardepapieren.westeurope.azurecontainer.io
    dnsNameLabel: waardepapieren-demo 
    ports:
    - protocol: tcp
      port: '443' 
    - protocol: tcp
      port: '3232' 
    - protocol: tcp
      port: '80'    
    - protocol: tcp
      port: '8880'      
tags: null
type: Microsoft.ContainerInstance/containerGroups
</code>
20191228_18_50 - END JOB :
-----------------------------------------------------------------------------
20191228_18_50 - END JOB :
-----------------------------------------------------------------------------
====== az_clone_build_ship_deploy.bash ======
| 20191228_18_50 | /Users/boscp08/Projects/scratch/virtual-insanity/AZ_ACI_waardepapieren-demo_westeurope_azurecontainer_io|
| 20191228_18_50 | az_clone_build_ship_deploy.bash |
<code>
</code>
====== menu.bash  ======
| 20191228_18_50 | /Users/boscp08/Projects/scratch/virtual-insanity/AZ_ACI_waardepapieren-demo_westeurope_azurecontainer_io|
| 20191228_18_50 | menu.bash |
<code>
#!/bin/bash
# A menu driven shell script sample template 
## ----------------------------------
# Step #1: Define variables
# ----------------------------------
EDITOR=nano
PASSWD=/etc/passwd
RED='\033[0;41;30m'
STD='\033[0;0;39m'

echo "A menu is nothing but a list of commands presented to a user by a shell script"
sleep 1
 . az_aci_clone_build_ship_deploy.bash
 PROMPT=true 
# ----------------------------------
# Step #2: User defined function
# ----------------------------------
pause(){
  read -p "Press [Enter] key to continue..." fackEnterKey
} 
# function to display menus
show_menus() {
	clear
	echo "~~~~~~~~~~~~~~~~~~~~~"	
	echo " M A I N - M E N U"
	echo "~~~~~~~~~~~~~~~~~~~~~"
	echo "1. docker_build_image mock_nlx ${DOCKER_VERSION_TAG}"
    echo "2. docker_build_image waardepapieren-service ${DOCKER_VERSION_TAG}"
    echo "3. docker_build_image clerk-frontend ${DOCKER_VERSION_TAG}"
    echo "4. Reset (docker system prune -a)"
	echo "5. reload az_aci_clone_build_ship_deploy.bash"
	echo "6. open -a Firefox 'https://hub.docker.com/?ref=login' boscp08 Peter!...."
	echo "7. open -a Firefox 'https://portal.azure.com/#home' bosch.peter@outlook.com 0l..ten"
    echo "8. open -a Firefox https://$CERT_HOST_IP:443  " #hope the clerk frontend will be stable "
	echo "9. open -a Firefox https://github.com/BoschPeter/$GIT_REPO "
    echo "10..) az login -u bosch.peter@outlook.com"
    echo "11..) delete_azure_resource_group $AZ_RESOURCE_GROUP "
    echo "12..) create_azure_resource_group $AZ_RESOURCE_GROUP"
    echo "13..) create_azure_container_group $AZ_RESOURCE_GROUP"
    echo "14..) restart_azure_container_group $AZ_RESOURCE_GROUP  a.ka. (re) pull docker hub"
	echo "15. backup scripts"
	echo "16 Exit"
}
# read input from the keyboard and take a action
# invoke the one() when the user select 1 from the menu option.
# invoke the two() when the user select 2 from the menu option.
# Exit when user the user select 3 form the menu option.
read_options(){
	local choice
	read -p "Enter choice [ 1 - 15] " choice
	case $choice in
		1) docker_build_image mock-nlx  ${DOCKER_USER} ${MOCK_NLX_IMAGE} ${DOCKER_VERSION_TAG}  ;;
        2) docker_build_image waardepapieren-service ${DOCKER_USER} ${SERVICE_IMAGE} ${DOCKER_VERSION_TAG}  ;;
        3) docker_build_image clerk-frontend ${DOCKER_USER} ${CLERK_FRONTEND_IMAGE} ${DOCKER_VERSION_TAG}  ;;
        4) docker_system_prune ;;
		5) . az_aci_clone_build_ship_deploy.bash ;;
		6) open -a Firefox 'https://hub.docker.com/?ref=login' ;;
        7) open -a Firefox 'https://portal.azure.com/#home' ;;
		8) open -a Firefox https://$CERT_HOST_IP:443 ;;
		9) open -a Firefox https://github.com/BoschPeter/$GIT_REPO ;;
		10) az login -u bosch.peter@outlook.com -p 0lifanten ;;
	    11) delete_azure_resource_group  ;;
        12) create_azure_resource_group  ;;
        13) create_azure_container_group ;;
        14) restart_azure_container_group ;;
        15) write_az_clone_build_ship_deploy_bash ;;
		16) exit 0;;
		*) echo -e "${RED}Error...${STD}" && sleep 2
	esac
}
 
# ----------------------------------------------
# Step #3: Trap CTRL+C, CTRL+Z and quit singles
# ----------------------------------------------
trap '' SIGINT SIGQUIT SIGTSTP
 
# -----------------------------------
# Step #4: Main logic - infinite loop
# ------------------------------------
while true
do
 
	show_menus
	read_options
done

</code>
